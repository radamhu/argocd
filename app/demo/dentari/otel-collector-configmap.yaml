---
apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-collector-config
  labels:
    app: otel-collector
data:
  otel-collector-config.yaml: |
    # ==============================================================================
    # OpenTelemetry Collector Configuration - K3s Edition
    # Dentari - Observability Pipeline
    # ==============================================================================

    # ==============================================================================
    # RECEIVERS - How telemetry data enters the collector
    # ==============================================================================
    receivers:
      # OTLP Receiver - receives data via OpenTelemetry Protocol
      otlp:
        protocols:
          # gRPC endpoint (default: 4317)
          grpc:
            endpoint: 0.0.0.0:4317

          # HTTP endpoint (default: 4318)
          http:
            endpoint: 0.0.0.0:4318
            cors:
              allowed_origins:
                - "*"

    # ==============================================================================
    # PROCESSORS - How telemetry data is processed/transformed
    # ==============================================================================
    processors:
      # Batch Processor - batches telemetry data before exporting
      batch:
        timeout: 10s
        send_batch_size: 1024
        send_batch_max_size: 2048

      # Memory Limiter - prevents OOM
      memory_limiter:
        check_interval: 1s
        limit_mib: 200
        spike_limit_mib: 50

      # Resource Processor - adds resource attributes
      resource:
        attributes:
          - key: service.name
            value: dentari
            action: upsert
          - key: service.version
            value: 0.1.3
            action: upsert
          - key: deployment.environment
            value: kubernetes
            action: upsert
          - key: service.namespace
            value: dentari-app
            action: upsert

      # Attributes Processor - modifies attributes
      attributes:
        actions:
          - key: collector.name
            value: dentari-otel-collector
            action: upsert
          - key: k8s.cluster.name
            value: k3s-home
            action: upsert

    # ==============================================================================
    # EXPORTERS - Where telemetry data is sent
    # ==============================================================================
    exporters:
      # OTLP Exporter to Grafana Cloud
      otlp/grafana:
        endpoint: ${GRAFANA_CLOUD_OTLP_ENDPOINT}
        headers:
          authorization: ${GRAFANA_CLOUD_OTLP_HEADERS}
        compression: gzip
        timeout: 30s
        retry_on_failure:
          enabled: true
          initial_interval: 5s
          max_interval: 30s
          max_elapsed_time: 300s

      # Logging Exporter - for debugging
      logging:
        loglevel: info
        sampling_initial: 5
        sampling_thereafter: 200

    # ==============================================================================
    # EXTENSIONS - Additional functionality
    # ==============================================================================
    extensions:
      # Health Check endpoint
      health_check:
        endpoint: 0.0.0.0:13133
        path: /

      # Performance profiling
      pprof:
        endpoint: 0.0.0.0:1777

    # ==============================================================================
    # SERVICE - Pipeline definitions
    # ==============================================================================
    service:
      extensions: [health_check, pprof]

      telemetry:
        logs:
          level: info
        metrics:
          level: detailed
          address: 0.0.0.0:8888

      pipelines:
        # Logs Pipeline (Active)
        logs:
          receivers: [otlp]
          processors:
            - memory_limiter
            - resource
            - attributes
            - batch
          exporters:
            - otlp/grafana
            - logging
