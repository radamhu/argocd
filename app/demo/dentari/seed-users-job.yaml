---
apiVersion: batch/v1
kind: Job
metadata:
  name: dentari-seed-users
  namespace: dentari
  labels:
    app: dentari
    component: seed-job
spec:
  # Keep the pod for 1 hour after completion for log inspection
  ttlSecondsAfterFinished: 3600
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: dentari
        component: seed-job
    spec:
      restartPolicy: OnFailure
      containers:
        - name: seed-users
          image: ghcr.io/radamhu/dentari:latest
          imagePullPolicy: Always
          command:
            - "python"
            - "-c"
            - |
              import bcrypt
              import sqlite3
              from pathlib import Path

              def hash_password(password: str) -> str:
                  return bcrypt.hashpw(password.encode("utf-8"), bcrypt.gensalt()).decode("utf-8")

              db_path = "/app/data/dentari.db"
              print(f"üå± Seeding users to {db_path}...")

              conn = sqlite3.connect(db_path)
              cursor = conn.cursor()

              # Check if tables exist
              cursor.execute("SELECT name FROM sqlite_master WHERE type='table' AND name IN ('users', 'user_sessions')")
              existing_tables = {row[0] for row in cursor.fetchall()}

              if 'users' not in existing_tables:
                  print("üìã Creating users table...")
                  schema_sql = """
                  CREATE TABLE IF NOT EXISTS users (
                      id INTEGER PRIMARY KEY AUTOINCREMENT,
                      username TEXT UNIQUE NOT NULL,
                      email TEXT UNIQUE NOT NULL,
                      password_hash TEXT NOT NULL,
                      name TEXT NOT NULL,
                      role TEXT NOT NULL CHECK(role IN ('owner', 'courier', 'lab_manager', 'accountant')),
                      is_active BOOLEAN DEFAULT TRUE,
                      courier_name TEXT,
                      last_login_at TIMESTAMP,
                      failed_login_attempts INTEGER DEFAULT 0,
                      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                      updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                  );
                  CREATE TABLE IF NOT EXISTS user_sessions (
                      id INTEGER PRIMARY KEY AUTOINCREMENT,
                      user_id INTEGER NOT NULL,
                      session_token TEXT UNIQUE NOT NULL,
                      login_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                      logout_at TIMESTAMP,
                      ip_address TEXT,
                      user_agent TEXT,
                      success BOOLEAN DEFAULT TRUE,
                      FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
                  );
                  CREATE INDEX IF NOT EXISTS idx_users_username ON users(username);
                  CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);
                  CREATE INDEX IF NOT EXISTS idx_users_role ON users(role);
                  CREATE INDEX IF NOT EXISTS idx_users_active ON users(is_active);
                  CREATE INDEX IF NOT EXISTS idx_sessions_user ON user_sessions(user_id);
                  CREATE INDEX IF NOT EXISTS idx_sessions_token ON user_sessions(session_token);
                  """
                  cursor.executescript(schema_sql)
                  print("‚úÖ Schema created")

              users = [
                  {"username": "owner", "email": "owner@example.local", "password": "owner123", "name": "Owner", "role": "owner", "courier_name": None},
                  {"username": "courier1", "email": "courier1@example.local", "password": "courier123", "name": "Courier 1", "role": "courier", "courier_name": "Courier 1"},
              ]

              for user in users:
                  cursor.execute("SELECT username FROM users WHERE username = ?", (user["username"],))
                  if cursor.fetchone():
                      print(f"‚è≠Ô∏è  User '{user['username']}' already exists, skipping")
                      continue

                  password_hash = hash_password(user["password"])
                  cursor.execute(
                      "INSERT INTO users (username, email, password_hash, name, role, courier_name, is_active) VALUES (?, ?, ?, ?, ?, ?, TRUE)",
                      (user["username"], user["email"], password_hash, user["name"], user["role"], user["courier_name"])
                  )
                  print(f"‚úÖ Created user: {user['username']} ({user['role']})")

              conn.commit()

              print("\nüìã Current users:")
              cursor.execute("SELECT username, email, name, role FROM users")
              for row in cursor.fetchall():
                  print(f"‚úÖ {row[0]:12} | {row[2]:15} | {row[3]:12} | {row[1]}")

              conn.close()
              print("\n‚úÖ Seeding complete!")
              print("üîí Default credentials:")
              print("   Owner:   username=owner    password=owner123")
              print("   Courier: username=courier1 password=courier123")
              print("‚ö†Ô∏è  Change these passwords in production!")
          env:
            - name: PYTHONUNBUFFERED
              value: "1"
          volumeMounts:
            - name: data
              mountPath: /app/data
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "256Mi"
              cpu: "500m"
      imagePullSecrets:
        - name: ghcr-secret
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: dentari-data-pvc
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
